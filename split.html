<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Creator Pro V9 Mobile Fix</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@700&family=Poppins:wght@600&display=swap');

    body {
        margin: 0;
        background: #0f0f0f;
        color: white;
        font-family: 'Poppins', sans-serif;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden; /* Kunci scroll body */
    }

    /* --- AREA PREVIEW (CANVAS) --- */
    #preview-area {
        flex: 1;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        border-bottom: 2px solid #333;
    }

    canvas {
        max-width: 100%;
        max-height: 100%;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    /* Indikator REC */
    #rec-badge {
        position: absolute;
        top: 20px; right: 20px;
        background: red;
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        display: none;
        z-index: 99;
        box-shadow: 0 0 10px red;
        animation: pulse 1s infinite;
    }
    @keyframes pulse { 50% { opacity: 0.5; } }

    /* --- KONTROL PANEL --- */
    #controls {
        height: 45vh; /* Setengah layar */
        background: #1a1a1a;
        padding: 15px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        gap: 12px;
        overflow-y: auto;
    }

    .label { font-size: 12px; color: #aaa; margin-bottom: 4px; display:block; }

    textarea {
        width: 100%;
        height: 80px;
        background: #252525;
        color: #fff;
        border: 1px solid #444;
        border-radius: 8px;
        padding: 10px;
        font-family: 'Courier Prime', monospace;
        font-size: 14px;
        resize: none;
        box-sizing: border-box;
    }

    .row { display: flex; gap: 10px; }

    button {
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        color: white;
        font-size: 14px;
        cursor: pointer;
        width: 100%;
    }
    
    button:active { transform: scale(0.96); }

    .btn-blue { background: #2980b9; }
    .btn-red { background: #c0392b; }
    .btn-dark { background: #333; border: 1px solid #555; }
    .btn-stop { background: #e74c3c; animation: blink-btn 1s infinite; }

    @keyframes blink-btn { 50% { background: #c0392b; } }

    .hidden { display: none !important; }

</style>
</head>
<body>

<div id="preview-area">
    <div id="rec-badge">‚óè REC</div>
    <canvas id="mainCanvas" width="720" height="900"></canvas>
</div>

<div id="controls">

    <div>
        <span class="label">1. Tulis Cerita (Enter untuk ganti slide)</span>
        <textarea id="storyInput" placeholder="Malam itu sepi...
(Tekan Enter)
Aku mendengar suara langkah...
(Tekan Enter)
Ternyata dia datang..."></textarea>
    </div>

    <div class="row">
        <button class="btn-dark" onclick="document.getElementById('bgInput').click()">üì∏ Ganti Foto Background</button>
        <input type="file" id="bgInput" accept="image/*" hidden onchange="loadBackground(this)">
    </div>

    <span class="label">2. Aksi (Musik Otomatis Nyala)</span>
    <div class="row" id="action-buttons">
        <button class="btn-blue" onclick="previewAction()">‚ñ∂ Cek Dulu</button>
        <button class="btn-red" onclick="startRecording()">‚óè REKAM VIDEO</button>
    </div>
    
    <button id="stop-btn" class="btn-stop hidden" onclick="stopRecording()">‚ñ† STOP REKAM (Simpan)</button>

</div>

<script>
    // === CONFIG ===
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    
    // State
    let scenes = [];
    let currentSceneIdx = 0;
    let charIdx = 0;
    let textToDraw = "";
    let isTyping = false;
    let bgImage = null; // Object Image
    let animationId;
    
    // Recording State
    let mediaRecorder;
    let chunks = [];
    let audioCtx, destNode, oscNodes = []; // Untuk Musik

    // Default Teks saat load
    ctx.fillStyle = "black";
    ctx.fillRect(0,0, canvas.width, canvas.height);
    ctx.fillStyle = "white";
    ctx.font = "bold 30px Arial";
    ctx.textAlign = "center";
    ctx.fillText("Siap Digunakan", canvas.width/2, canvas.height/2);

    // === 1. LOGIKA BACKGROUND ===
    function loadBackground(input) {
        if(input.files && input.files[0]){
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    bgImage = img;
                    drawFrame(); // Refresh canvas
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // === 2. ENGINE GAMBAR (CANVAS LOOP) ===
    function drawFrame() {
        // 1. Gambar Background
        if(bgImage) {
            // Draw image full cover (simulasi object-fit: cover)
            const ratio = Math.max(canvas.width / bgImage.width, canvas.height / bgImage.height);
            const centerShift_x = (canvas.width - bgImage.width * ratio) / 2;
            const centerShift_y = (canvas.height - bgImage.height * ratio) / 2;
            ctx.drawImage(bgImage, 0, 0, bgImage.width, bgImage.height, centerShift_x, centerShift_y, bgImage.width * ratio, bgImage.height * ratio);
        } else {
            ctx.fillStyle = "#111";
            ctx.fillRect(0,0, canvas.width, canvas.height);
        }

        // 2. Gelapkan Background (Overlay)
        ctx.fillStyle = "rgba(0,0,0,0.5)";
        ctx.fillRect(0,0, canvas.width, canvas.height);

        // 3. Gambar Teks (Wrap Text Manual)
        ctx.fillStyle = "white";
        ctx.font = "bold 40px 'Courier Prime', monospace";
        ctx.textAlign = "left";
        ctx.textBaseline = "top";
        
        // Efek Shadow Teks
        ctx.shadowColor = "black";
        ctx.shadowBlur = 4;
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;

        wrapText(ctx, textToDraw + (isTyping ? "|" : ""), 50, canvas.height/2 - 100, 620, 55);
        
        // Reset shadow
        ctx.shadowColor = "transparent";
    }

    // Fungsi Pembungkus Teks (Supaya gak nabrak kanan)
    function wrapText(context, text, x, y, maxWidth, lineHeight) {
        let words = text.split(' ');
        let line = '';
        let startY = y;

        for(let n = 0; n < words.length; n++) {
            let testLine = line + words[n] + ' ';
            let metrics = context.measureText(testLine);
            let testWidth = metrics.width;
            if (testWidth > maxWidth && n > 0) {
                context.fillText(line, x, y);
                line = words[n] + ' ';
                y += lineHeight;
            } else {
                line = testLine;
            }
        }
        context.fillText(line, x, y);
    }

    // === 3. ENGINE KETIK (TYPING) ===
    function prepareStory() {
        const raw = document.getElementById('storyInput').value;
        if(!raw.trim()) { alert("Isi cerita dulu!"); return false; }
        scenes = raw.split(/\n+/).filter(x => x.trim() !== "");
        currentSceneIdx = 0;
        return true;
    }

    function playSequence(onFinish) {
        if(currentSceneIdx >= scenes.length) {
            if(onFinish) onFinish();
            return;
        }

        let fullText = scenes[currentSceneIdx];
        charIdx = 0;
        isTyping = true;
        
        let typeInterval = setInterval(() => {
            textToDraw = fullText.substring(0, charIdx);
            charIdx++;
            drawFrame(); // Update layar

            if(charIdx > fullText.length) {
                clearInterval(typeInterval);
                isTyping = false;
                drawFrame(); // Hapus kursor

                // Jeda baca 2 detik
                setTimeout(() => {
                    currentSceneIdx++;
                    playSequence(onFinish);
                }, 2000); 
            }
        }, 50); // Kecepatan ketik
    }

    // === 4. AUDIO ENGINE (MUSIK STORY) ===
    function startMusic() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        destNode = audioCtx.createMediaStreamDestination(); // Output khusus buat rekaman
        
        // Bikin Chord Ambient (C Minor Pad)
        const freqs = [130.81, 155.56, 196.00]; // C3, Eb3, G3
        
        freqs.forEach(f => {
            let osc = audioCtx.createOscillator();
            let gain = audioCtx.createGain();
            
            osc.type = 'sine'; // Suara halus
            osc.frequency.value = f;
            
            gain.gain.value = 0.1; // Volume kecil biar background
            
            osc.connect(gain);
            gain.connect(audioCtx.destination); // Ke speaker HP
            gain.connect(destNode); // Ke rekaman video
            
            osc.start();
            oscNodes.push(osc);
        });
    }

    function stopMusic() {
        if(oscNodes) {
            oscNodes.forEach(o => o.stop());
            oscNodes = [];
        }
        if(audioCtx) audioCtx.close();
    }

    // === 5. FUNGSI TOMBOL ===
    function previewAction() {
        if(!prepareStory()) return;
        textToDraw = "";
        playSequence(() => { textToDraw = "--- PREVIEW SELESAI ---"; drawFrame(); });
    }

    function startRecording() {
        if(!prepareStory()) return;

        // 1. Mulai Musik & Canvas Stream
        startMusic();
        
        // GABUNGKAN STREAM: Visual Canvas + Audio Musik
        const canvasStream = canvas.captureStream(30); // 30 FPS
        const audioStream = destNode.stream;
        
        // Mix Audio + Video
        const combinedTracks = [
            ...canvasStream.getVideoTracks(),
            ...audioStream.getAudioTracks()
        ];
        const finalStream = new MediaStream(combinedTracks);

        // 2. Setup Recorder
        mediaRecorder = new MediaRecorder(finalStream, {
            mimeType: 'video/webm;codecs=vp8' // Format paling aman buat Android
        });

        chunks = [];
        mediaRecorder.ondataavailable = e => {
            if(e.data.size > 0) chunks.push(e.data);
        };

        mediaRecorder.onstop = saveVideo;
        mediaRecorder.start();

        // UI
        document.getElementById('action-buttons').classList.add('hidden');
        document.getElementById('stop-btn').classList.remove('hidden');
        document.getElementById('rec-badge').style.display = 'block';

        // 3. Jalankan Animasi
        textToDraw = "";
        playSequence(() => {
            stopRecording(); // Stop otomatis pas cerita habis
        });
    }

    function stopRecording() {
        if(mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
        stopMusic();
        
        // Reset UI
        document.getElementById('action-buttons').classList.remove('hidden');
        document.getElementById('stop-btn').classList.add('hidden');
        document.getElementById('rec-badge').style.display = 'none';
    }

    function saveVideo() {
        const blob = new Blob(chunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        document.body.appendChild(a);
        a.style.display = 'none';
        a.href = url;
        
        // Nama file unik
        const date = new Date();
        a.download = `Story_${date.getHours()}${date.getMinutes()}.webm`;
        
        a.click();
        window.URL.revokeObjectURL(url);
        alert("Video tersimpan! Cek Galeri/Download.");
    }

    // Init awal
    drawFrame();

</script>

</body>
</html>
