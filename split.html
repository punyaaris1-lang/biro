<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Storyteller Engine V8 (Big Buttons)</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Poppins:wght@600&display=swap');

    body {
        margin: 0;
        background: #121212;
        color: white;
        font-family: 'Poppins', sans-serif;
        display: flex;
        flex-direction: column;
        height: 100vh;
    }

    /* --- LAYOUT ATAS: PREVIEW --- */
    #preview-area {
        flex: 1; /* Mengisi sisa ruang */
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        border-bottom: 2px solid #333;
    }

    #video-screen {
        width: 100%;
        max-width: 450px; /* Lebar HP */
        aspect-ratio: 4/5; /* Rasio FB/IG Aman */
        background: #222;
        background-size: cover;
        background-position: center;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 30px;
        box-sizing: border-box;
        position: relative;
    }

    /* Overlay biar teks jelas */
    #video-screen::before {
        content: '';
        position: absolute;
        top:0; left:0; right:0; bottom:0;
        background: rgba(0,0,0,0.6); 
        z-index: 1;
    }

    #display-text {
        position: relative;
        z-index: 2;
        font-family: 'Courier Prime', monospace; /* Font ala mesin ketik */
        font-size: 22px;
        line-height: 1.5;
        font-weight: bold;
        text-shadow: 1px 1px 2px black;
        white-space: pre-wrap;
        text-align: left;
        width: 100%;
    }

    /* Kursor kedip-kedip */
    .cursor::after {
        content: '|';
        animation: blink 1s infinite;
    }
    @keyframes blink { 50% { opacity: 0; } }

    /* Indikator Recording */
    #rec-indicator {
        position: absolute;
        top: 20px; right: 20px;
        background: red;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        display: none;
        z-index: 99;
        animation: pulse 1s infinite;
    }
    @keyframes pulse { 50% { opacity: 0.5; } }

    /* --- LAYOUT BAWAH: KONTROL --- */
    #control-panel {
        height: 50vh; /* Setengah layar buat ngedit */
        background: #1e1e1e;
        padding: 15px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        gap: 10px;
        overflow-y: auto;
        border-top: 2px solid #444;
    }

    /* JUDUL LABEL */
    .label-box {
        font-size: 14px;
        color: #bbb;
        margin-bottom: 5px;
        display: block;
    }

    /* AREA TEKS - DIBUAT JELAS BATASNYA */
    textarea {
        width: 100%;
        height: 120px; /* Tinggi fix biar lega */
        background: #2a2a2a;
        color: #fff;
        border: 2px solid #555; /* Batas Jelas */
        border-radius: 8px;
        padding: 12px;
        font-size: 14px;
        box-sizing: border-box;
        resize: none; /* Gabisa ditarik user, udah fix */
        font-family: 'Courier New', monospace;
    }
    textarea:focus {
        border-color: #00ff88;
        outline: none;
    }

    /* TOMBOL GROUP */
    .btn-group {
        display: grid;
        grid-template-columns: 1fr 1fr; /* 2 Kolom */
        gap: 10px;
        margin-top: 10px;
    }

    button {
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        text-transform: uppercase;
        color: white;
    }

    button:active { transform: scale(0.95); }

    /* WARNA TOMBOL BEDAIN BIAR JELAS */
    .btn-preview { background: #2196F3; } /* Biru */
    .btn-record { background: #ff3b30; box-shadow: 0 4px 15px rgba(255, 59, 48, 0.4); } /* Merah */
    .btn-stop { background: #555; } /* Abu */
    .btn-upload { background: #333; font-size: 12px; padding: 10px;}

    /* Utility */
    .hidden { display: none !important; }

</style>
</head>
<body>

<div id="preview-area">
    <div id="video-screen">
        <div id="rec-indicator">‚óè REC</div>
        <div id="display-text">Area Pratinjau.<br>Teks akan muncul di sini...</div>
    </div>
</div>

<div id="control-panel">

    <div>
        <span class="label-box">1. Masukkan Cerita (Pisahkan Paragraf dengan ENTER)</span>
        <textarea id="storyInput" placeholder="Tulis cerita di sini...
Contoh:
Pada suatu hari yang cerah...
(Tekan Enter)
Aku bertemu dengan seseorang...
(Tekan Enter)
Ternyata dia adalah..."></textarea>
    </div>

    <div style="display:flex; align-items:center; gap:10px;">
        <span class="label-box" style="flex:1">2. Background:</span>
        <button class="btn-upload" onclick="document.getElementById('bgFile').click()" style="flex:2">üì∏ GANTI FOTO</button>
        <input type="file" id="bgFile" accept="image/*" style="display:none" onchange="changeBG(this)">
    </div>

    <span class="label-box" style="margin-top:10px;">3. Kontrol Video:</span>
    <div class="btn-group">
        <button class="btn-preview" id="btnPlay" onclick="playPreview()">‚ñ∂ PLAY (Cek)</button>
        <button class="btn-record" id="btnRec" onclick="startRecord()">‚óè REKAM VIDEO</button>
    </div>
    
    <button class="btn-stop hidden" id="btnStop" onclick="stopRecord()" style="width:100%; margin-top:10px;">‚ñ† STOP RECORDING</button>

</div>

<script>
    // === VARIABLE ===
    let scenes = [];
    let currentScene = 0;
    let charIndex = 0;
    let typeTimer = null;
    let mediaRecorder;
    let recordedChunks = [];
    let isRecording = false;

    // === ELEMENT ===
    const display = document.getElementById('display-text');
    const screen = document.getElementById('video-screen');
    const input = document.getElementById('storyInput');
    const btnPlay = document.getElementById('btnPlay');
    const btnRec = document.getElementById('btnRec');
    const btnStop = document.getElementById('btnStop');
    const recInd = document.getElementById('rec-indicator');

    // === FUNGSI BACKGROUND ===
    function changeBG(input) {
        if (input.files && input.files[0]) {
            let reader = new FileReader();
            reader.onload = e => screen.style.backgroundImage = `url(${e.target.result})`;
            reader.readAsDataURL(input.files[0]);
        }
    }

    // === PERSIAPAN DATA ===
    function prepareScenes() {
        let raw = input.value;
        if (!raw.trim()) {
            display.innerHTML = "‚ö†Ô∏è Teks kosong! Tulis cerita dulu di bawah.";
            return false;
        }
        // Split berdasarkan Enter (\n)
        scenes = raw.split(/\n+/).filter(line => line.trim() !== "");
        currentScene = 0;
        return true;
    }

    // === MESIN KETIK (ANIMASI) ===
    function runTypewriter(callback) {
        if (currentScene >= scenes.length) {
            if (callback) callback(); // Panggil fungsi selesai
            return;
        }

        let txt = scenes[currentScene];
        display.innerHTML = ""; // Bersihkan layar
        display.classList.add('cursor'); // Tambah kursor
        charIndex = 0;

        // Loop ngetik per huruf
        typeTimer = setInterval(() => {
            display.innerText = txt.substring(0, charIndex);
            charIndex++;

            if (charIndex > txt.length) {
                clearInterval(typeTimer);
                display.classList.remove('cursor'); // Hapus kursor pas baca

                // Waktu baca: (Panjang teks * 50ms) + 1.5 detik jeda
                let readDelay = 1500; 
                setTimeout(() => {
                    currentScene++;
                    runTypewriter(callback);
                }, readDelay);
            }
        }, 50); // Kecepatan ngetik (makin kecil makin ngebut)
    }

    // === TOMBOL 1: PREVIEW (Cuma Nonton) ===
    function playPreview() {
        if(!prepareScenes()) return;
        
        // UI Update
        clearInterval(typeTimer);
        display.innerHTML = "Ready...";
        
        setTimeout(() => {
            runTypewriter(() => {
                display.innerHTML += "<br><br>[SELESAI]";
            });
        }, 500);
    }

    // === TOMBOL 2: RECORD (Rekam & Simpan) ===
    async function startRecord() {
        if(!prepareScenes()) return;

        try {
            // Minta izin layar (Pilih Tab Ini)
            const stream = await navigator.mediaDevices.getDisplayMedia({
                video: { frameRate: 60 },
                audio: false
            });

            // Setup Recorder
            recordedChunks = [];
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });

            mediaRecorder.ondataavailable = e => {
                if(e.data.size > 0) recordedChunks.push(e.data);
            };

            mediaRecorder.onstop = saveVideo;

            // Start
            mediaRecorder.start();
            isRecording = true;

            // UI Changes
            recInd.style.display = 'block'; // Munculin tanda REC
            btnRec.classList.add('hidden'); // Sembunyiin tombol Rec
            btnPlay.classList.add('hidden'); // Sembunyiin tombol Play
            btnStop.classList.remove('hidden'); // Munculin tombol Stop

            // Mulai Animasi
            runTypewriter(() => {
                stopRecord(); // Otomatis stop kalau teks habis
            });

        } catch (err) {
            alert("Gagal merekam: " + err);
        }
    }

    // === STOP & SAVE ===
    function stopRecord() {
        if(isRecording && mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(t => t.stop()); // Stop sharing icon
        }

        // Reset UI
        isRecording = false;
        recInd.style.display = 'none';
        btnRec.classList.remove('hidden');
        btnPlay.classList.remove('hidden');
        btnStop.classList.add('hidden');
    }

    function saveVideo() {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        document.body.appendChild(a);
        a.style.display = 'none';
        a.href = url;
        a.download = `Story_Video_${Date.now()}.webm`;
        a.click();
        window.URL.revokeObjectURL(url);
    }

</script>

</body>
</html>
