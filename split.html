<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Creator Pro V11: Render System</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@700&family=Poppins:wght@600&display=swap');

    body {
        margin: 0;
        background: #111;
        color: white;
        font-family: 'Poppins', sans-serif;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
    }

    /* --- LAYAR UTAMA --- */
    #viewport {
        flex: 1;
        position: relative;
        background: black;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
    }

    canvas {
        max-width: 100%;
        max-height: 100%;
        box-shadow: 0 0 30px rgba(0,0,0,0.5);
    }

    /* --- OVERLAY RENDER (LOADING SCREEN) --- */
    #render-overlay {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.95);
        z-index: 99;
        display: none; /* Default Hidden */
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
    }

    .spinner {
        width: 50px; height: 50px;
        border: 5px solid #333;
        border-top: 5px solid #00ff88;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    .progress-box {
        width: 80%;
        height: 10px;
        background: #333;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 10px;
    }
    #progress-bar {
        width: 0%;
        height: 100%;
        background: #00ff88;
        transition: width 0.3s;
    }

    /* --- KONTROL PANEL --- */
    #controls {
        height: 45vh;
        background: #1e1e1e;
        padding: 20px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        gap: 12px;
        border-top: 1px solid #333;
        overflow-y: auto;
    }

    textarea {
        width: 100%;
        height: 100px;
        background: #2a2a2a;
        color: #ddd;
        border: 1px solid #444;
        border-radius: 8px;
        padding: 12px;
        font-family: 'Courier Prime', monospace;
        resize: none;
        box-sizing: border-box;
    }
    textarea:focus { border-color: #00ff88; outline: none; }

    .btn-group { display: flex; gap: 10px; }
    
    button {
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        color: white;
        font-size: 14px;
        cursor: pointer;
        width: 100%;
        transition: transform 0.1s;
    }
    button:active { transform: scale(0.98); }

    .btn-preview { background: #3498db; } /* Biru */
    .btn-render { background: #27ae60; } /* Hijau */
    .btn-bg { background: #444; margin-bottom: 5px; }

    .hidden { display: none !important; }

</style>
</head>
<body>

<div id="viewport">
    <canvas id="mainCanvas" width="720" height="1280"></canvas>

    <div id="render-overlay">
        <div class="spinner"></div>
        <h2 style="color:#00ff88; margin:0;">RENDERING...</h2>
        <p style="color:#aaa; font-size:12px;">Mohon jangan tutup tab atau matikan layar</p>
        <div class="progress-box">
            <div id="progress-bar"></div>
        </div>
        <p id="progress-text" style="margin-top:5px; font-size:14px;">0%</p>
    </div>
</div>

<div id="controls">
    <div style="font-size:12px; color:#888; margin-bottom:5px;">1. EDITOR NASKAH (Enter = Ganti Slide)</div>
    <textarea id="storyInput" placeholder="Tulis ceritamu di sini..."></textarea>

    <div style="font-size:12px; color:#888; margin-bottom:5px;">2. VISUAL</div>
    <button class="btn-bg" onclick="document.getElementById('bgInput').click()">ðŸ“¸ Ganti Background</button>
    <input type="file" id="bgInput" hidden accept="image/*" onchange="loadBG(this)">

    <div style="font-size:12px; color:#888; margin-bottom:5px; margin-top:10px;">3. EKSEKUSI</div>
    <div class="btn-group">
        <button class="btn-preview" onclick="playPreview()">â–¶ PREVIEW AJA</button>
        <button class="btn-render" onclick="startRender()">âš¡ GENERATE & SAVE</button>
    </div>
</div>

<script>
    // === SYSTEM SETUP ===
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d', { alpha: false });
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const renderOverlay = document.getElementById('render-overlay');

    // State Variables
    let scenes = [];
    let currentSceneIdx = 0;
    let charDisplayCount = 0;
    let isRunning = false;
    let isRendering = false; // Mode Rekam atau Cuma Nonton
    let isPaused = false;
    
    // Time Logic
    let lastTime = 0;
    let charTimer = 0;
    let pauseTimer = 0;
    const charSpeed = 50; // ms per huruf
    const readDelay = 2000; // ms jeda baca

    // Assets
    let bgImage = null;
    let animationId;

    // Audio & Recorder
    let audioCtx, destNode, oscNodes = [];
    let mediaRecorder;
    let chunks = [];

    // --- INITIAL DRAW ---
    ctx.fillStyle = "black";
    ctx.fillRect(0,0, canvas.width, canvas.height);
    ctx.fillStyle = "#333";
    ctx.font = "30px Arial";
    ctx.textAlign = "center";
    ctx.fillText("READY", canvas.width/2, canvas.height/2);

    // --- FUNCTION: LOAD BG ---
    function loadBG(input) {
        if(input.files && input.files[0]) {
            const img = new Image();
            img.onload = () => {
                bgImage = img;
                if(!isRunning) drawRender(); // Refresh preview kalau lagi diam
            };
            img.src = URL.createObjectURL(input.files[0]);
        }
    }

    // --- FUNCTION: MUSIC ENGINE (Sad Piano) ---
    function initAudio(forRecording = false) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        // Kalau recording, output diarahkan ke MediaStreamDestination
        // Kalau preview, output diarahkan ke Speaker biasa
        let outputNode = audioCtx.destination;
        
        if(forRecording) {
            destNode = audioCtx.createMediaStreamDestination();
            outputNode = destNode; // Kita butuh ini buat masuk ke video
        }

        const freqs = [130.81, 155.56, 196.00, 65.41]; // C Minor
        
        freqs.forEach(f => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.value = f;
            gain.gain.value = 0.08;
            
            osc.connect(gain);
            gain.connect(outputNode);
            
            // Kalau recording, kita juga mau denger suaranya (optional, tapi enak buat monitoring)
            if(forRecording) gain.connect(audioCtx.destination); 

            osc.start();
            oscNodes.push(osc);
        });
    }

    function stopAudio() {
        if(oscNodes) oscNodes.forEach(o => o.stop());
        if(audioCtx) audioCtx.close();
        oscNodes = [];
    }

    // --- CORE ENGINE (GAME LOOP) ---
    function gameLoop(timestamp) {
        if(!isRunning) return;

        if (!lastTime) lastTime = timestamp;
        const deltaTime = timestamp - lastTime;
        lastTime = timestamp;

        updateLogic(deltaTime);
        drawRender();

        if(isRunning) requestAnimationFrame(gameLoop);
    }

    function updateLogic(dt) {
        if(currentSceneIdx >= scenes.length) {
            finishProcess(); // SELESAI
            return;
        }

        const currentText = scenes[currentSceneIdx];
        
        // Update Progress Bar (Estimasi Kasar)
        if(isRendering) {
            let totalProgress = (currentSceneIdx / scenes.length) * 100;
            let subProgress = (charDisplayCount / currentText.length) * (100 / scenes.length);
            let finalPerc = Math.min(Math.round(totalProgress + subProgress), 99);
            progressBar.style.width = finalPerc + "%";
            progressText.innerText = finalPerc + "%";
        }

        if(!isPaused) {
            // Logic Ngetik
            charTimer += dt;
            if(charTimer >= charSpeed) {
                charDisplayCount++;
                charTimer = 0;
                if(charDisplayCount > currentText.length) {
                    isPaused = true; 
                    pauseTimer = 0;
                }
            }
        } else {
            // Logic Jeda Baca
            pauseTimer += dt;
            if(pauseTimer >= readDelay) {
                isPaused = false;
                currentSceneIdx++;
                charDisplayCount = 0;
            }
        }
    }

    function drawRender() {
        // 1. BG
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        if(bgImage) {
            const ratio = Math.max(canvas.width / bgImage.width, canvas.height / bgImage.height);
            const cx = (canvas.width - bgImage.width * ratio) / 2;
            const cy = (canvas.height - bgImage.height * ratio) / 2;
            ctx.drawImage(bgImage, 0, 0, bgImage.width, bgImage.height, cx, cy, bgImage.width * ratio, bgImage.height * ratio);
        }

        // 2. Overlay Gelap
        ctx.fillStyle = "rgba(0,0,0,0.6)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // 3. Teks
        if(scenes[currentSceneIdx]) {
            const fullText = scenes[currentSceneIdx];
            const textToShow = fullText.substring(0, charDisplayCount);
            
            ctx.fillStyle = "white";
            ctx.font = "bold 42px 'Courier Prime', monospace";
            ctx.textAlign = "left";
            ctx.textBaseline = "top";
            
            wrapText(ctx, textToShow + (isPaused ? "" : "|"), 60, canvas.height/2 - 100, 600, 55);
        }
    }

    function wrapText(context, text, x, y, maxWidth, lineHeight) {
        const words = text.split(' ');
        let line = '';
        for(let n = 0; n < words.length; n++) {
            const testLine = line + words[n] + ' ';
            const metrics = context.measureText(testLine);
            if (metrics.width > maxWidth && n > 0) {
                context.fillText(line, x, y);
                line = words[n] + ' ';
                y += lineHeight;
            } else { line = testLine; }
        }
        context.fillText(line, x, y);
    }

    // --- CONTROLS ---

    function prepare() {
        const raw = document.getElementById('storyInput').value;
        if(!raw.trim()) { alert("Ceritanya mana?"); return false; }
        scenes = raw.split(/\n+/).filter(x => x.trim() !== "");
        currentSceneIdx = 0;
        charDisplayCount = 0;
        lastTime = 0;
        isRunning = true;
        isPaused = false;
        return true;
    }

    // BUTTON 1: PREVIEW (Cuma Nonton)
    function playPreview() {
        if(!prepare()) return;
        isRendering = false; // Mode Preview
        initAudio(false); // Audio ke speaker
        requestAnimationFrame(gameLoop);
    }

    // BUTTON 2: RENDER (Generate & Download)
    function startRender() {
        if(!prepare()) return;
        isRendering = true; // Mode Render

        // UI Changes
        renderOverlay.style.display = 'flex'; // Tutup layar dengan loading screen
        progressBar.style.width = "0%";
        progressText.innerText = "0%";

        // Setup Audio & Video Stream
        initAudio(true); // Audio ke recorder
        
        const canvasStream = canvas.captureStream(30); // 30 FPS Stabil
        const audioStream = destNode.stream;
        const combined = new MediaStream([...canvasStream.getVideoTracks(), ...audioStream.getAudioTracks()]);

        mediaRecorder = new MediaRecorder(combined, {
            mimeType: 'video/webm;codecs=vp8',
            videoBitsPerSecond: 3000000 // 3 Mbps High Quality
        });

        chunks = [];
        mediaRecorder.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };
        mediaRecorder.onstop = saveVideo;
        mediaRecorder.start();

        // Start Loop
        requestAnimationFrame(gameLoop);
    }

    function finishProcess() {
        isRunning = false;
        stopAudio();
        
        if(isRendering) {
            // Kalau mode render, stop recorder
            if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            renderOverlay.style.display = 'none'; // Buka loading screen
            alert("Selesai! File sedang didownload.");
        } else {
            alert("Preview Selesai.");
        }
    }

    function saveVideo() {
        const blob = new Blob(chunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        document.body.appendChild(a);
        a.style.display = 'none';
        a.href = url;
        a.download = `Story_Result_${Date.now()}.webm`;
        a.click();
        window.URL.revokeObjectURL(url);
    }

</script>
</body>
</html>
