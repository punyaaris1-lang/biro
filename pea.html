<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FC KELAPA GADING - SYSTEM PRO</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Teko:wght@300;500;700&family=Rajdhani:wght@500;600;800&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg: #050505; --gold: #FFD700; --red: #FF003C; --cyan: #00F0FF; --green: #39FF14; --purple: #D900FF;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        
        body { 
            font-family: 'Rajdhani', sans-serif; background: #000;
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px; 
            color: #ddd; margin: 0; padding: 15px 20px 120px 20px; 
            min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden;
        }

        /* --- LOADING --- */
        #loading-screen {
            position: fixed; inset: 0; background: #000; z-index: 25000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s;
        }
        .loader-spinner { width: 50px; height: 50px; border: 3px solid #222; border-top: 3px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        .loader-text { font-family: 'Orbitron'; color: var(--gold); font-size: 14px; letter-spacing: 3px; animation: pulseText 1s infinite; }

        /* ========================================= */
        /* === SCREENSAVER: HERO CARD (CINEMATIC) === */
        /* ========================================= */
        #hangar-overlay { 
            position: fixed; inset: 0; z-index: 10000; 
            background: #050505; 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
            overflow: hidden;
        }

        /* Container Kartu */
        .hero-card {
            position: relative; width: 320px; height: 520px;
            background: linear-gradient(180deg, #000 0%, #151515 100%);
            border-radius: 15px; overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            border: 2px solid #333;
            display: flex; flex-direction: column; align-items: center;
            opacity: 0; transform: scale(0.9); transition: all 0.5s ease; /* Untuk Animasi Fade */
        }
        .hero-card.active { opacity: 1; transform: scale(1); }

        /* 1. Logo Aura (Background) */
        .hero-aura {
            position: absolute; top: -50px; left: -50px; width: 420px; height: 420px;
            background-image: url('logo.png'); /* LOGO MLU */
            background-size: contain; background-position: center; background-repeat: no-repeat;
            opacity: 0.2; mix-blend-mode: screen; filter: grayscale(100%) contrast(1.5);
            z-index: 0; animation: pulseAura 6s infinite ease-in-out;
        }

        /* 2. Foto Orang */
        .hero-img {
            position: absolute; top: 0; left: 0; width: 100%; height: 85%;
            object-fit: cover; object-position: top center; z-index: 1;
            /* Masking bawah agar nge-blend sama text */
            -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
            mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
            filter: contrast(1.1);
        }

        /* 3. Logo Badge (Kecil) */
        .hero-badge {
            position: absolute; top: 20px; right: 20px; width: 60px; height: 60px;
            background-image: url('1000307954.png'); /* LOGO MLU */
            background-size: contain; background-repeat: no-repeat; z-index: 2;
            mix-blend-mode: screen; filter: drop-shadow(0 0 5px var(--cyan));
        }

        /* 4. Teks Area */
        .hero-text {
            position: absolute; bottom: 0; width: 100%; height: 35%;
            background: linear-gradient(to top, #000 10%, transparent);
            z-index: 3; display: flex; flex-direction: column; justify-content: flex-end;
            padding-bottom: 30px; text-align: center;
        }
        .hero-jabatan {
            font-family: 'Black Ops One'; font-size: 32px; line-height: 1; margin: 0;
            background: linear-gradient(to bottom, var(--gold), #B8860B);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-transform: uppercase; letter-spacing: 1px;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.8));
        }
        .hero-nama {
            font-family: 'Teko'; font-size: 36px; color: #fff; margin: -5px 0 0 0;
            text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 10px #000;
        }
        .hero-line {
            width: 50%; height: 3px; background: var(--gold); margin: 5px auto 0 auto;
            border-radius: 2px; box-shadow: 0 0 10px var(--gold);
        }

        /* Loading Bar Screensaver */
        .ss-bar {
            position: absolute; bottom: 0; left: 0; height: 4px; background: var(--gold);
            width: 0%; z-index: 5;
        }

        /* ========================================= */
        /* === UI APP UTAMA === */
        /* ========================================= */
        .header { text-align: center; margin-bottom: 25px; margin-top: 10px; cursor: pointer; } 
        .main-title { font-family: 'Black Ops One'; font-size: 32px; line-height: 1; color: #eee; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }
        .sub-title { font-size: 11px; color: var(--gold); letter-spacing: 3px; font-weight: 700; text-transform: uppercase; margin-top: 5px; text-shadow: 0 0 10px rgba(255, 215, 0, 0.4); }

        .queue-bar-wrapper { width: 100%; margin-bottom: 25px; cursor: pointer; }
        .queue-bar { background: linear-gradient(180deg, #1a1a1a, #0d0d0d); clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px); padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; position: relative; }
        .queue-bar-inner { position: absolute; inset: 1px; background: linear-gradient(180deg, #151515, #0a0a0a); clip-path: polygon(14px 0, 100% 0, 100% calc(100% - 14px), calc(100% - 14px) 100%, 0 100%, 0 14px); z-index: -1; }
        .qb-left { display: flex; flex-direction: column; }
        .qb-lbl { font-size: 9px; color: #666; letter-spacing: 2px; text-transform: uppercase; font-weight: 700; }
        .qb-val { font-family: 'Teko'; font-size: 28px; color: #fff; display: flex; align-items: center; gap: 10px; }
        .qb-tot { font-family: 'Black Ops One'; font-size: 36px; line-height: 0.8; color: #fff; }

        .slot-container { display: flex; flex-direction: column; gap: 8px; width: 100%; }
        .armor-card { width: 100%; min-height: 85px; position: relative; background: #000; margin-bottom: 2px; transition: all 0.3s; clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px); }
        .armor-border { position: absolute; inset: 0; background: #333; z-index: 0; }
        .armor-card.active .armor-border { background: #555; box-shadow: 0 0 15px rgba(255,255,255,0.05); }
        .armor-inner { position: absolute; inset: 1px; background: linear-gradient(90deg, #121212, #080808); clip-path: polygon(14px 0, 100% 0, 100% calc(100% - 14px), calc(100% - 14px) 100%, 0 100%, 0 14px); display: flex; align-items: center; overflow: hidden; }
        
        .armor-num { width: 45px; height: 100%; min-height: 85px; display: flex; align-items: center; justify-content: center; font-family: 'Black Ops One'; font-size: 28px; color: #444; border-right: 1px solid #222; background: #0a0a0a; flex-shrink: 0; }
        .armor-card.active .armor-num { color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .armor-info { flex: 1; padding: 0 10px; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        .info-name { font-family: 'Rajdhani'; font-weight: 700; font-size: 10px; color: #FFD700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .info-plat { font-family: 'Teko'; font-size: 38px; line-height: 1; color: #fff; text-shadow: 2px 2px 0px #000; letter-spacing: 0.5px; white-space: nowrap; }
        .armor-badge { width: 100px; height: 100%; display: flex; align-items: center; justify-content: center; padding-right: 5px; flex-shrink: 0; }

        /* === BADGE ANIMATIONS LENGKAP === */
        /* 1. PRESIDEN MCU */
        .badge-presiden { width: 100px; height: 35px; background: linear-gradient(135deg, #500000, #800000); border: 2px solid #FFD700; border-radius: 4px; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); animation: pulseGoldBorder 2s infinite ease-in-out; }
        .badge-presiden::after { content: ''; position: absolute; top: -50%; left: -100%; width: 50%; height: 200%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent); transform: skewX(-20deg); animation: shinePass 2s infinite; }
        .txt-top-pres { font-size: 7px; color: #FFD700; font-weight: bold; letter-spacing: 1px; }
        .txt-main-pres { font-family: 'Black Ops One'; font-size: 10px; color: #fff; text-transform: uppercase; text-shadow: 0 0 5px #000; }

        /* 2. PROVOKATOR MCU */
        .badge-provokator { width: 100px; height: 35px; background: #220500; border: 1px solid #FF4500; border-radius: 4px; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 10px #FF4500; }
        .fire-anim { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; background: url('https://i.gifer.com/origin/d7/d7ac4f38b77abe73165d85edf2cb8d2e.gif'); background-size: cover; opacity: 0.3; mix-blend-mode: screen; }
        .txt-top-prov { font-size: 7px; color: #FFA500; letter-spacing: 1px; z-index: 2; }
        .txt-main-prov { font-family: 'Black Ops One'; font-size: 9px; color: #fff; z-index: 2; text-shadow: 0 0 5px #FF0000; text-transform: uppercase; }

        /* 3. PASUKAN SENYAP (Ninja V3) */
        .badge-senyap { width: 100px; height: 35px; background-color: #050505; border: 1px solid #333; border-radius: 4px; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px rgba(255, 255, 255, 0.05); }
        .senyap-text { font-family: 'Black Ops One'; font-size: 9px; color: #ccc; z-index: 2; text-transform: uppercase; letter-spacing: 1px; text-shadow: 2px 2px 0 #000; animation: textImpact 3s infinite ease-in-out; }
        .ninja-anim { position: absolute; font-size: 20px; z-index: 3; filter: drop-shadow(-5px 0 2px rgba(0,0,0,0.5)); animation: shadowDash 3s infinite ease-in-out; }
        .wind-group { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .wind { position: absolute; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.9), transparent); border-radius: 50%; opacity: 0; }
        .w1 { top: 20%; height: 1px; animation: windGust 3s infinite ease-in-out; }
        .w2 { top: 50%; height: 2px; animation: windGust 3s infinite ease-in-out 0.05s; }
        .w3 { top: 80%; height: 1px; animation: windGust 3s infinite ease-in-out 0.1s; }

        /* 4. DONATUR */
        .badge-donatur { width: 100px; height: 35px; background: #002200; border: 1px solid #00FF00; border-radius: 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; animation: pulseGreen 2s infinite; }
        .txt-donatur { font-family: 'Orbitron'; font-size: 10px; color: #00FF00; font-weight: bold; letter-spacing: 1px; }
        .icon-donatur { font-size: 12px; }

        /* 5. Badge Lainnya */
        .badge-keluarga { width: 100px; height: 35px; border: 1px solid #FFD700; border-radius: 4px; background: #000; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .bg-gold-flow { position: absolute; inset: -50%; background: conic-gradient(from 0deg, #423103, #FFD700, #FFF8DC, #FFD700, #423103); animation: rotateFlow 6s linear infinite; opacity: 0.6; }
        .text-layer { position: relative; z-index: 2; text-align: center; width: 100%; }
        .txt-top-fam { font-size: 7px; color: #fff; letter-spacing: 1px; font-weight: 800; text-transform: uppercase; }
        .txt-bot-fam { font-family: 'Orbitron'; font-size: 10px; color: #FFD700; letter-spacing: 1px; font-weight: 900; text-transform: uppercase; white-space: nowrap; }

        .badge-elite { width: 100px; height: 35px; background: linear-gradient(180deg, #1a1a1a, #000); border: 1px solid #B8860B; border-radius: 4px; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; animation: pulseGoldBorder 3s infinite ease-in-out; }
        .shine-bar { position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent); transform: skewX(-20deg); animation: shinePass 2.5s infinite ease-in-out; }
        .txt-top-elite { font-size: 7px; color: #aaa; letter-spacing: 2px; }
        .txt-bot-elite { font-family: 'Black Ops One'; font-size: 11px; background: linear-gradient(to bottom, #FFF8DC, #FFD700, #B8860B); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.3)); }

        .badge-commando { width: 100px; height: 35px; background: #220000; border: 1px solid #FF003C; border-radius: 4px; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; animation: hazardPulse 0.8s infinite alternate; }
        .hazard-stripes { position: absolute; inset: -50%; background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255, 0, 60, 0.2) 10px, rgba(255, 0, 60, 0.2) 20px); animation: hazardScroll 2s linear infinite; }
        .txt-commando { font-family: 'Black Ops One'; font-size: 14px; color: #FF003C; position: relative; z-index: 2; text-shadow: 0 0 8px #FF003C; }
        .siren-light { position: absolute; top: 3px; right: 3px; width: 5px; height: 5px; background: #FF003C; border-radius: 50%; box-shadow: 0 0 10px #FF003C; animation: blinkFast 0.3s infinite alternate; }

        .badge-office { width: 100px; height: 35px; background: #000505; border: 1px solid #00F0FF; border-radius: 4px; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; animation: pulseCyan 2s infinite ease-in-out; }
        .data-stream { position: absolute; inset: 0; background: repeating-linear-gradient(90deg, rgba(0, 240, 255, 0.03) 0px, rgba(0, 240, 255, 0.03) 1px, transparent 1px, transparent 4px); animation: scanDown 3s linear infinite, cyberGlitch 0.3s infinite steps(3) alternate; }
        .txt-office { font-family: 'Orbitron'; font-size: 14px; color: #00F0FF; position: relative; z-index: 2; letter-spacing: 2px; text-shadow: 0 0 5px #00F0FF; }

        .badge-turtle { width: 100px; height: 35px; background: #020502; border: 1px solid #39FF14; border-radius: 4px; position: relative; overflow: hidden; box-shadow: 0 0 10px rgba(57, 255, 20, 0.3); }
        .turtle-track { position: absolute; top: 0; left: 0; width: 100%; height: 20px; border-bottom: 1px dashed #1a4411; }
        .turtle-icon { position: absolute; top: 2px; font-size: 14px; transform: scaleX(-1); animation: runAndBrake 4s infinite cubic-bezier(0.1, 0.7, 1.0, 0.1); filter: drop-shadow(0 0 5px #39FF14); }
        .txt-turtle { position: absolute; bottom: 2px; width: 100%; text-align: center; font-size: 7px; font-weight: bold; color: #39FF14; font-family: 'Orbitron'; letter-spacing: 1px; }

        /* Keyframes */
        @keyframes rotateFlow { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
        @keyframes shinePass { 0% {left:-100%; opacity:0;} 50% {left:150%; opacity:1;} 100% {left:150%; opacity:0;} }
        @keyframes pulseGoldBorder { 0%, 100% { box-shadow: 0 0 5px rgba(184, 134, 11, 0.3); border-color: #B8860B; } 50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.7); border-color: #FFD700; } }
        @keyframes smolder { 0%, 100% { background: radial-gradient(circle at center, rgba(205, 90, 0, 0.1) 0%, #0f0a00 90%); border-color: #8B4513; } 50% { background: radial-gradient(circle at center, rgba(255, 140, 0, 0.4) 20%, #0f0a00 100%); border-color: #cd7f32; } }
        @keyframes hazardPulse { 0% { box-shadow: 0 0 5px #550000; border-color: #FF003C; background: #220000; } 100% { box-shadow: 0 0 25px #FF003C; border-color: #ff7777; background: #440000; } }
        @keyframes hazardScroll { 0% {background-position: 0 0;} 100% {background-position: 50px 0;} }
        @keyframes pulseCyan { 0%, 100% { box-shadow: 0 0 5px rgba(0, 240, 255, 0.2); border-color: #00F0FF; } 50% { box-shadow: 0 0 20px rgba(0, 240, 255, 0.6); border-color: #80ffff; } }
        @keyframes pulseGreen { 0%, 100% { box-shadow: 0 0 5px rgba(0, 255, 0, 0.2); } 50% { box-shadow: 0 0 15px rgba(0, 255, 0, 0.6); } }
        @keyframes cyberGlitch { 0% { transform: translate(0,0); opacity: 0.8; } 100% { transform: translate(-2px, 1px); opacity: 1; } }
        @keyframes runAndBrake { 0% { left: -20px; transform: scaleX(-1) skewX(0deg); } 40% { left: 85px; transform: scaleX(-1) skewX(20deg); } 45% { left: 75px; transform: scaleX(-1) skewX(-20deg); } 50% { left: 78px; transform: scaleX(-1) skewX(0deg); } 90% { left: 78px; opacity: 1; transform: scaleX(-1) skewX(0deg); } 100% { left: 78px; opacity: 0; transform: scaleX(-1) skewX(0deg); } }
        @keyframes shadowDash { 0% { left: -50px; opacity: 0; transform: skewX(50deg) scaleX(1.3); filter: blur(5px); } 10% { left: 15px; opacity: 1; transform: skewX(-10deg) scaleX(1); filter: blur(0px); } 15% { transform: skewX(0deg); } 75% { left: 15px; opacity: 1; transform: skewX(0deg); filter: blur(0px); } 80% { transform: skewX(-20deg); } 90% { left: 160px; opacity: 0; transform: skewX(-50deg) scaleX(1.3); filter: blur(5px); } 100% { left: 160px; opacity: 0; } }
        @keyframes windGust { 0%, 5% { left: -60px; width: 20px; opacity: 0; } 10% { left: 10px; width: 100px; opacity: 0.8; } 15% { left: 150px; width: 20px; opacity: 0; } 85% { left: 10px; width: 20px; opacity: 0; } 90% { left: 100px; width: 120px; opacity: 0.6; } 95% { left: 200px; width: 20px; opacity: 0; } }
        @keyframes textImpact { 0%, 8% { transform: translate(0, 0); color: #ccc; } 10% { transform: translate(3px, 0); color: #fff; text-shadow: 4px 0 5px rgba(255,255,255,0.5); } 12% { transform: translate(-2px, 0); } 14% { transform: translate(0, 0); color: #ccc; } 88% { transform: translate(0, 0); color: #ccc; } 90% { transform: translate(3px, 0); color: #fff; text-shadow: 4px 0 5px rgba(255,255,255,0.5); } 92% { transform: translate(-2px, 0); } 94% { transform: translate(0, 0); color: #ccc; } }
        @keyframes pulseAura { 0%, 100% { opacity: 0.2; transform: scale(1); } 50% { opacity: 0.4; transform: scale(1.05); } }
        @keyframes pulseText { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes blink { 0%,100% {opacity:1;} 50% {opacity:0.3;} }

        /* UI BOTTOM */
        .bottom-action-area { flex: 1; min-height: 150px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-top: 20px;}
        .sunken-btn-container { width: 120px; height: 120px; border-radius: 50%; background: #000; box-shadow: inset 10px 10px 20px #000, inset -5px -5px 15px #1a1a1a, 0 0 0 1px #111; display: flex; align-items: center; justify-content: center; position: relative; cursor: pointer; transition: transform 0.2s; }
        .sunken-btn-container:active { transform: scale(0.95); }
        .logo-img-sunken { width: 85px; height: 85px; object-fit: cover; border-radius: 50%; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.8)); opacity: 0.9; transition: 0.3s; }
        .sunken-btn-container:hover .logo-img-sunken { opacity: 1; filter: drop-shadow(0 0 15px rgba(255,215,0,0.3)); }
        .tap-hint { font-size: 10px; color: #444; letter-spacing: 4px; margin-top: 20px; font-weight: 900; text-transform: uppercase; }

        .btn-cancel-q {
            margin-top: 15px; background: linear-gradient(45deg, #300, #500); border: 1px solid #f00; color: #f00;
            padding: 10px 20px; font-family: 'Rajdhani'; font-weight: bold; border-radius: 5px; cursor: pointer;
            letter-spacing: 1px; display: none; /* Hidden by default */
        }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 20000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { width: 90%; max-width: 350px; background: #111; border: 1px solid var(--gold); padding: 25px; text-align: center; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); box-shadow: 0 0 20px rgba(255, 215, 0, 0.2); transform: scale(0.9); transition: transform 0.2s; }
        .modal-overlay.active .modal-box { transform: scale(1); }
        .modal-title { font-family: 'Black Ops One'; color: var(--gold); font-size: 22px; margin-bottom: 10px; }
        .modal-msg { font-family: 'Rajdhani'; color: #fff; font-size: 16px; margin-bottom: 20px; }
        .modal-btns { display: flex; gap: 10px; justify-content: center; }
        .btn-modal { flex: 1; padding: 10px; font-family: 'Teko'; font-size: 18px; border: none; cursor: pointer; clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px); }
        .btn-yes { background: var(--gold); color: #000; font-weight: bold; }
        .btn-no { background: #333; color: #fff; border: 1px solid #555; }

        .screen-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(5px); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .login-card { width: 100%; max-width: 320px; background: #111; border: 1px solid #333; padding: 40px 20px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.8); clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px); }
        .holo-input { background: transparent; border: none; border-bottom: 1px solid #555; width: 100%; color: #fff; font-family: 'Teko'; font-size: 42px; text-align: center; margin: 20px 0; text-transform: uppercase; }
        .btn-next { width: 100%; padding: 15px; background: #fff; color: #000; font-family: 'Rajdhani'; font-weight: bold; font-size: 18px; border:none; border-radius: 50px; cursor: pointer; }
        .queue-list-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; flex-direction: column; padding: 20px; backdrop-filter: blur(5px); }
        .ql-card { background: #111; border: 1px solid #333; width: 100%; max-width: 400px; margin: auto; border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; max-height: 80vh; }
        .ql-body { padding: 10px; overflow-y: auto; }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loader-spinner"></div>
        <div class="loader-text">SCANNING MLU SISTEM...</div>
    </div>

    <div id="customModal" class="modal-overlay">
        <div class="modal-box">
            <div id="modalTitle" class="modal-title">TITLE</div>
            <div id="modalMsg" class="modal-msg">Message goes here...</div>
            <div id="modalBtns" class="modal-btns"></div>
        </div>
    </div>

    <div id="hangar-overlay" onclick="wakeUp()">
        <div class="hero-card" id="ssCard">
            <div class="hero-aura"></div>
            
            <div class="hero-badge"></div>

            <img id="pFoto" class="hero-img" src="" alt="FOTO" onerror="this.src='https://placehold.co/320x520/111/444?text=NO+IMAGE'">

            <div class="hero-text">
                <div id="pJabatan" class="hero-jabatan"></div>
                <div id="pNama" class="hero-nama"></div>
                <div class="hero-line" id="pLine"></div>
            </div>

            <div id="pBar" class="ss-bar"></div>
        </div>
    </div>

    <div class="header" ondblclick="toggleAdmin()">
        <div class="main-title">FC KELAPA GADING</div>
        <div class="sub-title">SELAMAT DATANG DI RUMAH MLU</div>
    </div>

    <div class="queue-bar-wrapper" onclick="openQueueList()">
        <div class="queue-bar">
            <div class="queue-bar-inner"></div>
            <div class="qb-left">
                <span class="qb-lbl">ANTRIAN BERIKUTNYA</span>
                <div class="qb-val" id="nextQDisplay">--</div>
            </div>
            <div class="qb-right">
                <div class="qb-tot" id="totalQDisplay">0</div>
            </div>
        </div>
    </div>

    <div class="slot-container" id="slotsContainer"></div>

    <div class="bottom-action-area">
        <div class="sunken-btn-container" onclick="handleMainAction()">
            <img src="1763947427555.jpg" class="logo-img-sunken" alt="MENU">
        </div>
        <div class="tap-hint" id="tapLabel">TAP LOGO UNTUK DAFTAR</div>
        <button id="btnCancelQ" class="btn-cancel-q" onclick="cancelQueue()">‚ùå BATAL / KELUAR ANTRIAN</button>
        <div onclick="resetApp()" style="margin-top:10px; font-size:9px; color:#333; text-decoration:underline; cursor:pointer;">[ RESET APP ]</div>
    </div>

    <div id="regModal" class="screen-overlay">
        <div class="login-card">
            <div style="font-size:12px; color:#666; margin-bottom:5px; text-transform:uppercase; letter-spacing:2px;" id="regLabel">LANGKAH 1</div>
            <input type="text" id="regInput" class="holo-input" placeholder="B 1234 XYZ" autocomplete="off">
            <button class="btn-next" onclick="nextRegStep()">LANJUT</button>
            <button style="margin-top:20px; background:none; border:none; color:#666; font-family:'Rajdhani'; font-weight:bold; cursor:pointer;" onclick="closeModal('regModal')">BATAL</button>
        </div>
    </div>

    <div id="queueListModal" class="queue-list-modal">
        <div class="ql-card">
            <div style="padding:15px; text-align:center; border-bottom:1px solid #333; font-family:'Black Ops One'; font-size:20px;">DAFTAR TUNGGU</div>
            <div class="ql-body" id="qlBody"></div>
            <button style="width:100%; padding:15px; background:#222; color:#fff; border:none; font-family:'Rajdhani'; font-weight:bold;" onclick="closeModal('queueListModal')">TUTUP</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, runTransaction, collection, addDoc, getDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // === KONFIGURASI LOKASI ===
        const STATION_LAT = -6.171583; 
        const STATION_LNG = 106.899844; 
        const MAX_DIST_KM = 0.2; // Jarak untuk boleh daftar
        const AUTO_KICK_KM = 0.5; // Jarak 500m untuk Auto Kick
        
        function removeLoader() { const l = document.getElementById('loading-screen'); if(l) { l.style.opacity = '0'; setTimeout(()=>l.remove(), 500); } }

        function calculateDist(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function checkLocation() {
            return new Promise((resolve, reject) => {
                if(!navigator.geolocation) { removeLoader(); resolve(false); return; }
                navigator.geolocation.getCurrentPosition((pos) => {
                    const dist = calculateDist(STATION_LAT, STATION_LNG, pos.coords.latitude, pos.coords.longitude);
                    if(dist <= MAX_DIST_KM) resolve(true); else resolve(false);
                }, () => resolve(false), { enableHighAccuracy: true, timeout: 5000 });
            });
        }

        if(navigator.geolocation) {
            navigator.geolocation.watchPosition((pos) => {
                if(localStorage.getItem('myPlat')) {
                    const dist = calculateDist(STATION_LAT, STATION_LNG, pos.coords.latitude, pos.coords.longitude);
                    if(dist > AUTO_KICK_KM) {
                        alert(`ANDA TERDETEKSI JAUH (${Math.round(dist*1000)}m) DARI LOKASI.\nSISTEM OTOMATIS MERESET AKSES ANDA.`);
                        localStorage.clear();
                        location.reload();
                    }
                }
            }, (err) => {}, {enableHighAccuracy: true, maximumAge: 10000});
        }

        const firebaseConfig = { apiKey: "AIzaSyB666i9lYWIpxOdkwpoX9EvFvHLmHczeq8", authDomain: "fcgadingnew22.firebaseapp.com", projectId: "fcgadingnew22", storageBucket: "fcgadingnew22.firebasestorage.app", messagingSenderId: "537736846678", appId: "1:537736846678:web:53788d71a196423ac08af7" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const mainRef = doc(db, "antrian", "utama");
        const historyRef = collection(db, "riwayatCharging");
        const logRef = collection(db, "activityLog");
        
        const $ = (id) => document.getElementById(id);
        let localSlots = [null, null, null]; let localQueue = []; let myPlat = localStorage.getItem('myPlat'); 

        function cleanStr(s) { return s ? s.replace(/[^A-Z0-9]/gi, '').toUpperCase() : ''; }
        function escapeHtml(text) { if (!text) return ""; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
        function addUserLog(action, details) { addDoc(logRef, { actor: myPlat || "GUEST", action: action, details: details, timestamp: new Date() }).catch(e=>{}); }

        window.toggleAdmin = () => { const pass = prompt("MASUKKAN KODE ADMIN:"); if(pass === "1131") window.location.href = "admin.html"; else if (pass) showAlert("KODE AKSES SALAH!", "AKSES DITOLAK"); };
        window.showAlert = (msg, title="INFO") => { $('modalTitle').innerText = title; $('modalMsg').innerText = msg; $('modalBtns').innerHTML = `<button class="btn-modal btn-yes" onclick="closeCustomModal()">OK</button>`; $('customModal').style.display = 'flex'; setTimeout(() => $('customModal').classList.add('active'), 10); };
        window.showConfirm = (msg, callback) => { $('modalTitle').innerText = "KONFIRMASI"; $('modalMsg').innerText = msg; $('modalBtns').innerHTML = `<button class="btn-modal btn-no" onclick="closeCustomModal()">BATAL</button><button class="btn-modal btn-yes" id="btnYes">YA</button>`; $('btnYes').onclick = () => { closeCustomModal(); callback(); }; $('customModal').style.display = 'flex'; setTimeout(() => $('customModal').classList.add('active'), 10); };
        window.closeCustomModal = () => { $('customModal').classList.remove('active'); setTimeout(() => $('customModal').style.display = 'none', 200); };
        window.closeModal = (id) => { $(id).style.display = 'none'; };

        $('regInput').addEventListener('input', function(e) { if(formStep === 0) { let v = this.value.toUpperCase().replace(/[^A-Z0-9]/g, ''); let formatted = ""; if (v.length > 0) { let match = v.match(/^([A-Z]{1,2})(\d{0,4})([A-Z]*)$/); if (match) { formatted = match[1]; if (match[2]) formatted += " " + match[2]; if (match[3]) formatted += " " + match[3]; } else { formatted = v; } } this.value = formatted; } });

        // --- SCREENSAVER LOGIC (HERO CARD) ---
        // PENTING: Ganti nama file foto (sandi_dayyan.jpg dll) sesuai file yang bapak punya.
        const pengurusList = [
            { nama: "KI AHMAD", jabatan: "KETUA UMUM", foto: "aki.jpg", color: "#FFD700" }, // Foto Ketum Asli
            { nama: "SANDI DAYYAN", jabatan: "WAKIL KETUA UMUM", foto: "sandi_dayyan.jpg", color: "#00F0FF" },
            { nama: "DEDI UBAY", jabatan: "SEKERTARIS", foto: "dedi_ubay.jpg", color: "#00F0FF" },
            { nama: "BANG IWAN", jabatan: "PEMBINA", foto: "bang_iwan.jpg", color: "#E5E4E2" },
            { nama: "PAK AJI", jabatan: "PENASEHAT", foto: "pak_aji.jpg", color: "#E5E4E2" },
            { nama: "FERRY", jabatan: "HUMAS", foto: "ferry.jpg", color: "#39FF14" },
            { nama: "DONI", jabatan: "HUMAS", foto: "doni.jpg", color: "#39FF14" },
            { nama: "AMAR", jabatan: "KORLAP", foto: "amar.jpg", color: "#FF003C" },
            { nama: "SANDI", jabatan: "KORLAP", foto: "sandi_korlap.jpg", color: "#FF003C" },
            { nama: "SANDI JET LEE", jabatan: "SATGAS", foto: "sandi_jetlee.jpg", color: "#FF4500" },
            { nama: "HENDRO", jabatan: "SATGAS", foto: "hendro.jpg", color: "#FF4500" }
        ];
        
        let ssIndex = 0; let ssTimer;
        let idleTime = 0; let isStandby = false;
        
        setInterval(() => { 
            idleTime++; const limit = myPlat ? 300 : 30; 
            if (idleTime > limit && !isStandby) enterStandby(); 
        }, 1000);
        
        function resetTimer() { idleTime = 0; }
        window.onclick = resetTimer; window.ontouchstart = resetTimer;
        
        function enterStandby() { 
            if($('regModal').style.display === 'flex') return; 
            isStandby = true; 
            $('hangar-overlay').style.display = 'flex'; 
            cycleProfile(); 
        }
        
        window.wakeUp = () => { 
            if(!isStandby) return; 
            $('hangar-overlay').style.display = 'none'; 
            isStandby = false; 
            clearTimeout(ssTimer);
            resetTimer(); 
        };

        function cycleProfile() {
            if(!isStandby) return;
            const p = pengurusList[ssIndex];
            const card = $('ssCard'); const bar = $('pBar');
            const line = $('pLine');
            const jabatan = $('pJabatan');
            
            // Animasi Keluar
            card.classList.remove('active');
            bar.style.transition = 'none'; bar.style.width = '0%';
            
            setTimeout(() => {
                $('pFoto').src = p.foto;
                $('pJabatan').innerText = p.jabatan;
                $('pNama').innerText = p.nama;
                
                // Ubah warna aksen sesuai jabatan
                line.style.backgroundColor = p.color;
                line.style.boxShadow = `0 0 10px ${p.color}`;
                jabatan.style.background = `linear-gradient(to bottom, ${p.color}, #888)`;
                jabatan.style.webkitBackgroundClip = "text";
                bar.style.backgroundColor = p.color;
                bar.style.boxShadow = `0 0 10px ${p.color}`;

                card.classList.add('active'); // Animasi Masuk
                
                setTimeout(() => {
                    bar.style.transition = `width 7000ms linear`;
                    bar.style.width = '100%';
                }, 300);
            }, 500);

            ssTimer = setTimeout(() => {
                ssIndex = (ssIndex + 1) % pengurusList.length;
                cycleProfile();
            }, 8000);
        }

        onSnapshot(mainRef, (snap) => {
            removeLoader(); if (!snap.exists()) return; const d = snap.data(); localSlots = d.chargingSlots || [null, null, null]; localQueue = d.waitingQueue || []; updateUI();
        }, (err) => removeLoader());

        function updateUI() {
            const container = $('slotsContainer'); container.innerHTML = ''; let myQIndex = -1;
            
            if (myPlat && localQueue.length > 0) {
                myQIndex = localQueue.findIndex(q => cleanStr(q.plat) === cleanStr(myPlat));
            }

            // BUTTON CANCEL LOGIC
            const btnCancel = $('btnCancelQ');
            const tapLabel = $('tapLabel');
            if(myQIndex > -1) {
                btnCancel.style.display = 'block';
                tapLabel.innerText = `POSISI ANTRIAN: #${myQIndex+1}`;
            } else {
                btnCancel.style.display = 'none';
                tapLabel.innerText = myPlat ? "ANDA TERDAFTAR SEBAGAI MEMBER" : "TAP LOGO UNTUK DAFTAR";
            }

            localSlots.forEach((s, i) => {
                const isActive = s !== null; const div = document.createElement('div'); div.className = `armor-card ${isActive ? 'active' : ''}`;
                if (isActive) {
                    const role = s.role ? s.role.toUpperCase() : "GUEST"; const isMe = (cleanStr(s.plat) === cleanStr(myPlat)); let kudetaHTML = '', timerHTML = '';
                    const durationMs = Date.now() - (s.startTime || Date.now()); const durationMin = Math.floor(durationMs / 60000);
                    
                    if(isMe) timerHTML = `<div class="mini-timer">${durationMin} MIN</div>`; 
                    else if (myPlat) { 
                        timerHTML = `<div class="mini-timer">${durationMin} MIN</div>`; 
                        if (myQIndex === 0 && durationMin >= 20) kudetaHTML = `<button class="btn-kudeta" onclick="window.kudeta(${i}, '${escapeHtml(s.plat)}')">‚ö° KUDETA</button>`;
                        else if (myQIndex === 1 && durationMin >= 25) kudetaHTML = `<button class="btn-kudeta" onclick="window.kudeta(${i}, '${escapeHtml(s.plat)}')">‚ö° KUDETA</button>`;
                    }
                    div.innerHTML = `<div class="armor-border"></div><div class="armor-inner"><div class="armor-num">${i+1}</div><div class="armor-info"><div class="info-name">${escapeHtml(s.userName)}</div><div class="info-plat">${s.plat}</div></div><div class="armor-badge">${getBadgeHTML(role)}</div>${timerHTML}${kudetaHTML}</div>`;
                    if(isMe) div.onclick = () => showConfirm("SELESAI CHARGING?", () => stopCharging(i));
                } else {
                    let btnHTML = ''; 
                    if (!myPlat) btnHTML = `<button style="padding:5px 15px; font-family:'Rajdhani'; font-weight:bold; background:#222; color:#666; border:1px solid #333; border-radius:4px;" onclick="window.selectSlot(${i})">PILIH</button>`; 
                    else if (localQueue.length === 0) btnHTML = `<button style="padding:5px 15px; font-family:'Rajdhani'; font-weight:bold; background:#222; color:#666; border:1px solid #333; border-radius:4px;" onclick="window.selectSlot(${i})">PILIH</button>`; 
                    else if (myQIndex === 0) btnHTML = `<button style="padding:5px 15px; font-family:'Rajdhani'; font-weight:bold; background:var(--gold); color:#000; border:none; border-radius:4px; box-shadow:0 0 10px var(--gold);" onclick="window.selectSlot(${i})">PILIH</button>`; 
                    else if (myQIndex > 0) btnHTML = `<div style="font-family:'Rajdhani'; font-size:10px; color:#555; font-weight:bold;">ANTRIAN KE-${myQIndex + 1}</div>`; 
                    else btnHTML = `<div style="font-family:'Rajdhani'; font-size:10px; color:#333;">LOCKED</div>`;
                    
                    div.innerHTML = `<div class="armor-inner" style="background:#080808; border:1px solid #1a1a1a;"><div class="armor-num" style="color:#222; border-color:#111;">${i+1}</div><div class="armor-info" style="align-items:center;"><div class="info-plat" style="color:#333; letter-spacing:5px;">OPEN</div></div><div class="armor-badge">${btnHTML}</div></div>`;
                }
                container.appendChild(div);
            });
            $('totalQDisplay').innerText = localQueue.length; $('nextQDisplay').innerText = localQueue.length > 0 ? localQueue[0].plat : "--";
        }

        // === LOGIKA BADGE TERBARU (KOMPLIT) ===
        function getBadgeHTML(r) {
            if (!r || r === "GUEST") return ""; 
            if (r.includes("PRESIDEN MCU")) return `<div class="badge-presiden"><div class="txt-top-pres">MAKA CAVALRY</div><div class="txt-main-pres">PRESIDEN MCU</div></div>`;
            if (r.includes("PROVOKATOR")) return `<div class="badge-provokator"><div class="fire-anim"></div><div class="txt-top-prov">HEAD OF</div><div class="txt-main-prov">PROVOKATOR</div></div>`;
            
            // PASUKAN SENYAP (NINJA V3)
            if (r.includes("SENYAP") || r.includes("NINJA")) return `<div class="badge-senyap"><div class="wind-group"><div class="wind w1"></div><div class="wind w2"></div><div class="wind w3"></div></div><div class="ninja-anim">ü•∑</div><div class="senyap-text">PASUKAN SENYAP</div></div>`;
            
            // DONATUR
            if (r.includes("DONATUR")) return `<div class="badge-donatur"><div class="txt-donatur">DONATUR</div><div class="icon-donatur">üí∏üíé</div></div>`;

            if (["KETUA UMUM", "WAKETUM", "SEKJEN", "PEMBINA", "KACAB"].some(x => r.includes(x))) {
                let txtTop = "FC GADING"; 
                if(r.includes("KACAB")) txtTop = "BRANCH MANAGER";
                if(r.includes("PEMBINA")) txtTop = "ADVISOR";
                return `<div class="badge-elite"><div class="shine-bar"></div><div class="txt-top-elite">${txtTop}</div><div class="txt-bot-elite">${r}</div></div>`;
            }
            if (r.includes("DULUNYA")) return `<div class="badge-legend"><div class="txt-legend">DULUNYA<br>PEMBINA</div></div>`;
            if (r.includes("SATGAS") || r.includes("KORLAP")) return `<div class="badge-commando"><div class="hazard-stripes"></div><div class="siren-light"></div><div class="txt-commando">${r}</div></div>`;
            if (r.includes("OFFICE")) return `<div class="badge-office"><div class="data-stream"></div><div class="txt-office">OFFICE</div></div>`;
            if (r.includes("PELAN") || r.includes("TURTLE")) return `<div class="badge-turtle"><div class="turtle-track"><div class="turtle-icon">üê¢üí®</div></div><div class="txt-turtle">PELAN TAPI KENCENG</div></div>`;
            return `<div class="badge-keluarga"><div class="bg-gold-flow"></div><div class="text-layer"><div class="txt-top-fam">KELUARGA MLU</div><div class="txt-bot-fam">${r}</div></div></div>`;
        }

        window.openQueueList = () => { const body = $('qlBody'); body.innerHTML = ''; if(localQueue.length === 0) body.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">KOSONG</div>'; else { localQueue.forEach((q) => { body.innerHTML += `<div style="background:#222; margin:5px; padding:10px; border-left:3px solid gold;"><div style="font-family:'Teko'; font-size:24px;">${q.plat}</div><div style="font-size:12px; color:#888;">${q.userName}</div></div>`; }); } $('queueListModal').style.display = 'flex'; };

        window.handleMainAction = async () => { 
            if(localStorage.getItem('myPlat')) { 
                const p = localStorage.getItem('myPlat'); 
                const isInQueue = localQueue.some(q => cleanStr(q.plat) === cleanStr(p));
                const isInSlot = localSlots.some(s => s && cleanStr(s.plat) === cleanStr(p));
                if(isInQueue || isInSlot) return showAlert("ANDA SUDAH TERDAFTAR!\nCEK LAYAR UNTUK POSISI.", "SUDAH MASUK"); 
                else { localStorage.removeItem('myPlat'); myPlat=null; } 
            }
            const isInside = await checkLocation(); 
            if(!isInside) { showAlert("GPS LOCK: Wajib di lokasi FC Kelapa Gading.", "AKSES DITOLAK"); return; } 
            showLoginForm(); 
        };

        let formStep=0; let regData={}; const steps = [{l:"LANGKAH 1", q:"PLAT NOMOR"}, {l:"LANGKAH 2", q:"NAMA ANDA"}];
        function showLoginForm() { $('regModal').style.display = 'flex'; formStep = 0; renderRegStep(); }
        function renderRegStep() { $('regLabel').innerText = steps[formStep].l; $('regInput').placeholder = (formStep===0) ? "B 1234 XYZ" : "NAMA"; $('regInput').value = ""; $('regInput').focus(); }
        
        window.nextRegStep = async () => {
            let val = $('regInput').value.trim().toUpperCase(); if(!val) return;
            if(formStep === 0) { 
                regData.plat = val; formStep++; renderRegStep(); 
            } else {
                regData.name = val; 
                $('regModal').style.display = 'none'; 
                const cleanID = regData.plat.replace(/[^A-Z0-9]/g, ''); 
                let userRole = "GUEST"; 
                try { let m = await getDoc(doc(db, "members", cleanID)); if(m.exists()) userRole = m.data().role || "MEMBER"; } catch(e) {}
                try {
                    const docSnap = await getDoc(mainRef);
                    if(docSnap.exists()) {
                        const d = docSnap.data();
                        const allUsers = [...(d.chargingSlots||[]), ...d.waitingQueue].filter(x=>x);
                        const existing = allUsers.find(u => cleanStr(u.plat) === cleanStr(regData.plat));
                        if(existing) {
                            localStorage.setItem('myPlat', existing.plat);
                            myPlat = existing.plat; updateUI();
                            showAlert(`SESI DIPULIHKAN!\nHALO KEMBALI, ${existing.userName}.`, "WELCOME BACK");
                            return; 
                        }
                    }
                } catch(e) {}
                runTransaction(db, async(t) => { 
                    const d = (await t.get(mainRef)).data(); 
                    const n = (d.lastTicket||0)+1; 
                    const all = [...(d.chargingSlots||[]), ...d.waitingQueue].filter(x=>x); 
                    if(all.some(u => u.plat.replace(/[^A-Z0-9]/g, '') === cleanID)) throw "PLAT SUDAH ADA!"; 
                    t.update(mainRef, { waitingQueue: arrayUnion({ plat: regData.plat, userName: regData.name, qNo: n, entryTime: Date.now(), role: userRole }), lastTicket: n }); 
                }).then(() => { 
                    localStorage.setItem('myPlat', regData.plat); myPlat = regData.plat; 
                    addUserLog("REGISTER", `${regData.plat}`); 
                    showAlert(`SELAMAT DATANG!\nSTATUS: ${userRole}`, "SUKSES"); 
                }).catch(e=>showAlert(e, "GAGAL"));
            }
        };

        window.cancelQueue = () => {
            if(!myPlat) return;
            showConfirm("BATAL & KELUAR DARI ANTRIAN?", () => {
                runTransaction(db, async(t) => {
                    const d = (await t.get(mainRef)).data();
                    const newQ = d.waitingQueue.filter(q => cleanStr(q.plat) !== cleanStr(myPlat));
                    t.update(mainRef, { waitingQueue: newQ });
                    addUserLog("CANCEL", `User ${myPlat} keluar antrian`);
                }).then(() => {
                    localStorage.removeItem('myPlat'); myPlat = null;
                    showAlert("ANDA TELAH KELUAR ANTRIAN", "SUKSES");
                    setTimeout(() => location.reload(), 1500);
                }).catch(e => showAlert("GAGAL: " + e));
            });
        };

        window.selectSlot = async (i) => {
            if(!myPlat) return showAlert("DAFTAR DULU!"); if (localQueue.length > 0 && cleanStr(localQueue[0].plat) !== cleanStr(myPlat)) return showAlert(`HARAP TUNGGU GILIRAN!`, "ANTRIAN");
            showConfirm(`MASUK SLOT ${i+1}?`, () => { runTransaction(db, async(t)=>{ const d = (await t.get(mainRef)).data(); if(d.chargingSlots[i]) throw "SLOT PENUH!"; let q = d.waitingQueue; const idx = q.findIndex(x => cleanStr(x.plat) === cleanStr(myPlat)); if(idx === -1) throw "DAFTAR ULANG!"; const me = q[idx]; q.splice(idx, 1); me.startTime = Date.now(); d.chargingSlots[i] = me; t.update(mainRef, { chargingSlots: d.chargingSlots, waitingQueue: q }); }).then(() => addUserLog("START", `Slot ${i+1}`)).catch(e => showAlert(e)); });
        };
        
        window.stopCharging = (i) => { runTransaction(db, async(t)=>{ const d = (await t.get(mainRef)).data(); const u = d.chargingSlots[i]; if(u) addDoc(historyRef, {...u, finishTime: new Date(), action: "STOP"}); d.chargingSlots[i] = null; t.update(mainRef, {chargingSlots: d.chargingSlots}); }).then(() => { localStorage.clear(); myPlat=null; location.reload(); }); };
        
        window.kudeta = (i, targetPlat) => { 
            event.stopPropagation(); 
            showConfirm(`KUDETA ${targetPlat}?`, () => { 
                runTransaction(db, async(t)=>{ 
                    const d = (await t.get(mainRef)).data(); 
                    const u = d.chargingSlots[i]; 
                    if(!u) throw "Slot kosong!"; 
                    const dur = (Date.now() - u.startTime) / 60000; 
                    const qIdx = d.waitingQueue.findIndex(x => cleanStr(x.plat) === cleanStr(myPlat));
                    if (qIdx === 0 && dur < 20) throw "BELUM 20 MENIT!";
                    if (qIdx === 1 && dur < 25) throw "BELUM 25 MENIT!";
                    if (qIdx > 1) throw "ANDA BELUM BERHAK KUDETA!";
                    addDoc(historyRef, {...u, finishTime: new Date(), action: "KUDETA_BY_" + myPlat}); 
                    addUserLog("KUDETA", `Kudeta ${targetPlat}`); 
                    d.chargingSlots[i] = null; 
                    t.update(mainRef, {chargingSlots: d.chargingSlots}); 
                }).catch(e => showAlert(e)); 
            }); 
        };
        window.resetApp = () => showConfirm("RESET APLIKASI?", () => { localStorage.clear(); location.reload(); });
        
        window.onload = () => { const urlParams = new URLSearchParams(window.location.search); if (localStorage.getItem('myPlat') || urlParams.get('action') === 'register') { isStandby = false; $('hangar-overlay').style.display = 'none'; if(urlParams.get('action') === 'register') showLoginForm(); } else enterStandby(); };
    </script>
</body>
</html>
  
